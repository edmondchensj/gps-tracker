<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    
    <!-- Packages -->
    <link rel='stylesheet' type='text/css' href="./lib/bootstrap.min.css">
    <link rel='stylesheet' type='text/css' href="./css/style.css">
    <link rel='stylesheet' type='text/css' href="./lib/leaflet-1.6.0/leaflet.css">
    
    <!-- Home screen icons, prepared using https://pixelied.com/ and https://favicon.io/-->
    <link rel="apple-touch-icon" href="./assets/favicon/apple-touch-icon.png">
    <link rel="shortcut icon" href="./assets/favicon/favicon.ico">
    <link rel="manifest" href="./assets/favicon/site.webmanifest">

    <title>GPS Tracker</title>
</head>

<body>

    <div class="font-weight-light bg-primary text-center py-2">
        <img class='mx-auto' 
            src="./assets/bus.png" 
            style='max-width:40px; max-height:40px; padding-bottom: 1px; filter: invert(100%);'>
    </div>
    <div class="container my-1">
        <div class="initial-load" id="main">
            <div class="row px-2 justify-content-center mt-4">
                <div class="spinner-border mt-2 text-black-50" role="status">
                    <span class="sr-only">Loading...</span>
                </div>
            </div>
        </div>

        <div class="row">
            <button class="btn btn-link text-muted ml-auto mt-3 mr-2" id="logout" onclick="logout()">Logout</button>
        </div>
    </div>
</body>

<script src="./lib/jquery.min.js"></script>
<script src="./lib/leaflet-1.6.0/leaflet.js"></script>

<!-- Amazon Cognito for Authentication -->
<script src="./lib/aws-sdk-2.7.16.min.js"></script> 
<script src="./lib/aws-cognito/amazon-cognito-auth.min.js"></script>  
<script src="./config.js"></script>
<script src="./lib/aws-cognito/amazon-cognito-identity.min.js"></script>

<!-- Run validation for user session -->
<script type="module">
    import { validateCognitoUser, getUser } from "./js/auth.js"
    import { goToPage } from "./js/utils.js"
    
    window.logout = function() {
        console.log("Logging out ...")
        var cognitoUser = getUser();
        if (cognitoUser != null) {
            cognitoUser.signOut();
        }
        goToPage("login");
        history.replaceState(null, null, ' '); // clear URL hash
    }

    // Provide hidden logout route for admin
    let path = window.location.hash;
    console.log("current path: ", path);
    if (path == "#/logout") {
        logout();
    }

    console.log("Running Cognito user session validation")
    const success = validateCognitoUser();
    console.log("Cognito user validation success: ", success);

    const logout_link = document.getElementById("logout");
    if (!success) {
        console.log("Cognito user invalid, redirecting to login");
        logout_link.style.display = "none"; 
        goToPage("login");
    } else {
        logout_link.style.display = "block"; 
        const main = document.getElementById("main")
        if (main.classList.contains("initial-load")) {
            // Redirect to home screen if it is first time
            main.classList.remove("initial-load");
            goToPage("select-bus");
        }
    }
</script>
